<?xml version="1.0" encoding="UTF-8"?>

<xwikidoc version="1.3" reference="BachelorsAndMastersManagement.Note.Code.NotaMacros" locale="">
  <web>BachelorsAndMastersManagement.Note.Code</web>
  <name>NotaMacros</name>
  <language/>
  <defaultLanguage></defaultLanguage>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <creationDate>1356998400000</creationDate>
  <parent>xwiki:BachelorsAndMastersManagement.Note.Code.WebHome</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <date>1356998400000</date>
  <contentUpdateDate>1356998400000</contentUpdateDate>
  <version>1.1</version>
  <title>Nota Macros</title>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content>{{velocity}}
#set($notaClass = "BachelorsAndMastersManagement.Note.Code.NotaClass")
#set($notaClassObj = $xwiki.getDocument($notaClass).xWikiClass)
#set($notaObjectRoot = "BachelorsAndMastersManagement.Note.Code.NotaObjects")

#macro(getNotaPage $student)
  #set($macro.space = $services.model.resolveSpace($notaObjectRoot))
  #set($macro.pageName = $services.model.resolveDocument($student).name)
  #set($macro.docRef = $services.model.resolveDocument($macro.pageName, $macro.space))
  #set($macro.doc = $xwiki.getDocument($macro.docRef))
  #set($notaPage = $macro.doc)
#end

#macro(saveNota $student $profesor $proba $nota)
  #if(!$nota.matches($notaClassObj.nota.validationRegExp))
    &lt;b&gt;Nota pentru $student la $proba ($nota) nu este valida&lt;/b&gt;: $notaClassObj.nota.validationMessage&lt;br&gt;
    #break($macro)
  #end
  #getNotaPage($student)
  #foreach($obj in $notaPage.getObjects($notaClass))
    #if($obj.getProperty("student").value == $student &amp;&amp; $obj.getProperty("profesor").value == $profesor &amp;&amp; $obj.proba == $proba)
      ## found existing nota, update value
      #if($obj.nota != $nota)
        #if($nota.trim() != "")
          $obj.set("nota", $nota)
        #else
          $notaPage.removeObject($obj)
        #end
        $notaPage.save()
      #end
      #break($macro)
    #end
  #end
  #if($nota.trim() != "")
    #set($macro.obj = $notaPage.newObject($notaClass))
    $macro.obj.set("student", $student)
    $macro.obj.set("profesor", $profesor)
    $macro.obj.set("proba", $proba)
    $macro.obj.set("nota", $nota)
    $notaPage.save()
  #end
#end
{{/velocity}}</content>
</xwikidoc>
