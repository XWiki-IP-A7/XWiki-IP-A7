<?xml version='1.1' encoding='UTF-8'?>
<xwikidoc version="1.3" reference="BachelorsAndMastersManagement.Registration.Bachelors.WebHome" locale="">
  <web>BachelorsAndMastersManagement.Registration.Bachelors</web>
  <name>WebHome</name>
  <language/>
  <defaultLanguage>en</defaultLanguage>
  <translation>0</translation>
  <creator>XWiki.CristiHasna</creator>
  <creationDate>1526935979000</creationDate>
  <author>XWiki.CristiHasna</author>
  <contentAuthor>XWiki.CristiHasna</contentAuthor>
  <date>1526986683000</date>
  <contentUpdateDate>1526986683000</contentUpdateDate>
  <version>38.1</version>
  <title/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>false</hidden>
  <content>{{velocity}}&#xd;
&#xd;
## ----------variabile de erori&#xd;
#set ($project_title_error = false)&#xd;
#set ($project_ref_error = false)&#xd;
#set ($coordinator_error = false)&#xd;
#set ($courses_error = false)&#xd;
## ----------numarul de cursuri ce trebuie alese&#xd;
#set($maxCoursesDoc = $xwiki.getDocument('BachelorsAndMastersManagement.Setup.SetupData'))&#xd;
#set($maxCoursesObj = $maxCoursesDoc.getObject('BachelorsAndMastersManagement.Setup.CoursesCount.WebHome'))&#xd;
#set($maxCourses = $maxCoursesObj.getProperty('count').value)&#xd;
#if (!$maxCourses)&#xd;
	#set ($maxCourses = 4)&#xd;
#end&#xd;
#set($username = $xcontext.user)&#xd;
## ----------oprim comentariile, anotarile, atasamentele si istoricul pentru pagina de inregistrare&#xd;
#set ($showcomments = false)&#xd;
#set ($showannotations = false)&#xd;
#set ($showattachments = false)&#xd;
#set ($showhistory = false)&#xd;
#set ($showinformation = false)&#xd;
## ----------query pentru cursurile definite la pasul de setup, salvate intr-o lista&#xd;
#set($hql = "select distinct doc.name from XWikiDocument as doc where doc.space='BachelorsAndMastersManagement.Setup.Courses' and doc.name &lt;&gt; 'WebPreferences' and doc.name &lt;&gt; 'WebHome'")&#xd;
#set($results = $xwiki.search($hql))&#xd;
## ----------obtinem fisierul corespunzator candidatului si obiectele din acesta&#xd;
#set ($docName = 'BachelorsAndMastersManagement.Registration.Candidates.BachelorCandidates.' + $username.replace('XWiki.', ''))&#xd;
#set ($doc = $xwiki.getDocument($docName))&#xd;
#set ($obj = $doc.getObject('BachelorsAndMastersManagement.Registration.Candidate.Code.CandidateClass'))&#xd;
#set ($courses = [])&#xd;
## ----------documentul este nou, creem noi obiecte pentru datele candidatului&#xd;
#if ($doc.isNew())&#xd;
	#set ($obj = $doc.newObject('BachelorsAndMastersManagement.Registration.Candidate.Code.CandidateClass'))&#xd;
	#foreach ($i in [1..$maxCourses])&#xd;
		#set ($discard = $courses.add($doc.newObject('AppWithinMinutes.String')))&#xd;
	#end&#xd;
#else&#xd;
	#set ($project_title = $obj.getProperty('project_title').value)&#xd;
	#set ($project_ref = $obj.getProperty('project_ref').value)&#xd;
	#set ($coordinator = $obj.getProperty('coordinator').value)&#xd;
	#set ($courses = $doc.getObjects('AppWithinMinutes.String'))&#xd;
	#if ($courses.size() &lt; $maxCourses)&#xd;
		#set ($diff = $maxCourses - $courses.size())&#xd;
		#foreach ($i in [1..$diff])&#xd;
			#set ($discard = $courses.add($doc.newObject('AppWithinMinutes.String')))&#xd;
		#end&#xd;
	#end&#xd;
	#if ($courses.size() > $maxCourses)&#xd;
		#set ($upBound = $courses.size() - 1)&#xd;
		#foreach ($i in [$maxCourses..$upBound])&#xd;
			#set ($discard = $doc.removeObject($courses[$i]))&#xd;
		#end&#xd;
	#end&#xd;
#end&#xd;
#if ($request.get('submit'))&#xd;
	#set ($project_title = $request.get('project_title'))&#xd;
	#if($project_title == '')&#xd;
		#set ($project_title_error = true)&#xd;
	#end&#xd;
	#set ($project_ref = $request.get('project_reference'))&#xd;
	#if ($project_ref == '')&#xd;
		#set ($project_ref_error = true)&#xd;
	#end&#xd;
	#if ($request.get('coordinator') != '')&#xd;
		#set ($coordinator = $request.get('coordinator'))&#xd;
	#else&#xd;
		#set ($coordinator = $request.get('coordinatorBackup'))&#xd;
	#end&#xd;
	#if ($coordinator == '')&#xd;
		#set ($coordinator_error = true)&#xd;
	#end&#xd;
	## ---------- pentru fiecare curs ales, il punem in lista&#xd;
	#set($i = 0)&#xd;
	#foreach ($item in $results)&#xd;
		#if ($request.get($item))&#xd;
			#set ($discard = $courses[$i].set('shortText', $item))&#xd;
			#set ($i = $i+1)&#xd;
		#end&#xd;
	#end&#xd;
	#if ($i != $maxCourses)&#xd;
		#set ($courses_error = true)&#xd;
	#end&#xd;
	#if ($project_title_error == false and $project_ref_error == false and $coordinator_error == false and $courses_error == false )&#xd;
		#set ($discard = $obj.set('full_name', $xwiki.getUserName($username, false)))&#xd;
		#set ($discard = $obj.set('project_title', $project_title))&#xd;
		#set ($discard = $obj.set('project_ref', $project_ref))&#xd;
		#set ($discard = $obj.set('coordinator', $coordinator))&#xd;
		#set ($discard = $doc.save())&#xd;
	#end&#xd;
#end&#xd;
&#xd;
{{html clean="false"}}&#xd;
&#xd;
&lt;style type="text/css">&#xd;
&#xd;
	.noselect {&#xd;
	  -webkit-touch-callout: none; /* iOS Safari */&#xd;
	    -webkit-user-select: none; /* Safari */&#xd;
	     -khtml-user-select: none; /* Konqueror HTML */&#xd;
	       -moz-user-select: none; /* Firefox */&#xd;
	        -ms-user-select: none; /* Internet Explorer/Edge */&#xd;
	            user-select: none; /* Non-prefixed version, currently&#xd;
	                                  supported by Chrome and Opera */&#xd;
	}&#xd;
&#xd;
	.triggers-panel{&#xd;
		cursor: pointer;&#xd;
	}&#xd;
	#candidate-registration input[type=text]{&#xd;
		padding: 0 1em;&#xd;
	}&#xd;
	#candidate-registration input[type=text].no-padding-right{&#xd;
		padding-right: 0;&#xd;
	}&#xd;
	#candidate-registration input.suggestUsers{&#xd;
		padding-left: 2em;&#xd;
	}&#xd;
	#candidate-registration .indent-left{&#xd;
		padding-left: 30px;&#xd;
		border-left: 1px solid #cdcdcd;&#xd;
	}&#xd;
	#candidate-registration .row{&#xd;
		margin: 10px 0;&#xd;
	}&#xd;
	#candidate-registration .row .row{&#xd;
		margin: 0;&#xd;
	}&#xd;
	#candidate-registration .row.courses-container label{&#xd;
		font-size: 12px;&#xd;
	}&#xd;
	#candidate-registration .row.courses-container .col .col{&#xd;
		padding: 0;&#xd;
	}&#xd;
	#candidate-registration .row.courses-container{&#xd;
		position: relative;&#xd;
		height: 75px;&#xd;
		overflow: hidden;&#xd;
	}&#xd;
	#candidate-registration .row.courses-container.visible{&#xd;
		height: 100%;&#xd;
		overflow: visible;&#xd;
	}&#xd;
	#courses-trigger{&#xd;
		float: left;&#xd;
		margin-right: 10px;&#xd;
	}&#xd;
	#courses-trigger i{&#xd;
		display: none;&#xd;
	}&#xd;
	#courses-trigger i#down{&#xd;
		display: block;&#xd;
	}&#xd;
	#courses-trigger.triggered i#up{&#xd;
		display: block;&#xd;
	}&#xd;
	#courses-trigger.triggered i#down{&#xd;
		display: none;&#xd;
	}&#xd;
	.courses-container .courses-cover{&#xd;
		display: block;&#xd;
		z-index: 1;&#xd;
		position: absolute;&#xd;
		bottom: 0;&#xd;
		opacity: 1;&#xd;
		left: 0;&#xd;
		width: 100%;&#xd;
		height: 75px;&#xd;
		background: linear-gradient(transparent, #fff);&#xd;
	}&#xd;
	.courses-container.visible .courses-cover{&#xd;
		opacity: 0;&#xd;
		z-index: -1;&#xd;
	}&#xd;
	.select-course{&#xd;
		width: calc(100% - 22px);&#xd;
	    text-align: center;&#xd;
	    cursor: pointer;&#xd;
	    padding: 10px;&#xd;
	    border-radius: 10px;&#xd;
	    border: 1px solid #ccc;&#xd;
	    background: #efefef;&#xd;
	}&#xd;
	.course-check{&#xd;
		display: none !important;&#xd;
	}&#xd;
	.course-check[checked]+.select-course{&#xd;
		background: #84eb69;&#xd;
	}&#xd;
	p.errors, span.errors{&#xd;
		color: #ff0000;&#xd;
	}&#xd;
	ul.users ~ ul.accepted-suggestions{&#xd;
		position: absolute;&#xd;
	    background: #fff;&#xd;
	    width: 100%;&#xd;
	    margin-top: -38px;&#xd;
	}&#xd;
	#coordinator-container br{&#xd;
		display: none;&#xd;
	}&#xd;
&lt;/style>&#xd;
&#xd;
&lt;h3>Salut, $xwiki.getUserName($xcontext.user, false)&lt;/h3>&#xd;
&lt;form action="#" method="POST" id="candidate-registration">&#xd;
	&lt;div class="row">&#xd;
		&lt;div class="col  col-xs-12">&#xd;
			&lt;label for="project_title">Titlul proiectului&lt;/label>&#xd;
		&lt;/div>&#xd;
		&lt;div class="col  col-xs-12">&#xd;
			&lt;input type="text" name="project_title" value="$!project_title" />&#xd;
&#xd;
		&lt;/div>&#xd;
        #if ($project_title_error)&#xd;
	         &lt;div class="col  col-xs-12">&#xd;
	            &lt;p class="errors" >Introduceți titlul proiectului.&lt;/p>&#xd;
	        &lt;/div>&#xd;
	    #end&#xd;
	&lt;/div>&#xd;
    &#xd;
	&lt;div class="row">&#xd;
		&lt;div class="col  col-xs-12">&#xd;
			&lt;label for="project_reference">Sursa proiectului&lt;/label>&#xd;
		&lt;/div>&#xd;
		&lt;div class="col  col-xs-12">&#xd;
			&lt;input type="text" name="project_reference"   value="$!project_ref"/>&#xd;
		&lt;/div>&#xd;
        #if($project_ref_error)&#xd;
			&lt;div class="col  col-xs-12">&#xd;
				&lt;p class="errors">Introduceți link către sursa și documentația proiectului.&lt;/p>&#xd;
			&lt;/div>&#xd;
	    #end&#xd;
	&lt;/div>&#xd;
	&lt;div class="row">&#xd;
		&lt;div class="col  col-xs-12">&#xd;
			&lt;label for="coordinator">Profesorul coordonator&lt;/label>&#xd;
		&lt;/div>&#xd;
		&lt;div id="coordinator-container" class="col col-xs-12">&#xd;
			{{/html}}&#xd;
			$doc.display('coordinator')&#xd;
			{{html clean="false"}}&#xd;
			&lt;input type="text" class="no-padding-right suggestUsers withTip" autocomplete="on" name="coordinator" />&#xd;
			&lt;input type="hidden" name="coordinatorBackup" value="$coordinator">&#xd;
		&lt;/div>&#xd;
		#if ($coordinator_error)&#xd;
			&lt;div class="col col-xs-12">&#xd;
				&lt;p class="errors" >Selectați profesorul coordonator.&lt;/p>&#xd;
			&lt;/div>&#xd;
        #end&#xd;
	&lt;/div>&#xd;
	&lt;div class="row triggers-panel">&#xd;
		&lt;div class="col col-xs-12">&#xd;
			&lt;div id="courses-trigger">&#xd;
				&lt;i class="fa fa-chevron-down" id="down">&lt;/i>&#xd;
				&lt;i class="fa fa-chevron-up" id="up">&lt;/i>&#xd;
			&lt;/div>&#xd;
			&lt;label class="noselect">Cursuri &lt;span id="courses-status">&lt;/span>&lt;/label>&#xd;
			#if ($courses_error)&#xd;
				&lt;div class="col col-xs-12">&#xd;
					&lt;p class="errors"&gt;Selectați $maxCourses cursuri din lista de mai jos&lt;/p>&#xd;
				&lt;/div>&#xd;
			#end&#xd;
		&lt;/div>&#xd;
	&lt;/div>&#xd;
	&lt;div class="row courses-container" id="courses-panel">&#xd;
		&lt;div class="courses-cover triggers-panel visible">&lt;/div>&#xd;
		&lt;div class="col col-xs-12">&#xd;
			&lt;div class="row">&#xd;
			#foreach ($item in $results)&#xd;
				&lt;div class="col col-lg-3 col-md-4 col-sm-6 col-xs-12">&#xd;
					#set ($found = false)&#xd;
					#foreach ($course in $courses)&#xd;
						#if ($course.shortText == $item)&#xd;
							#set ($found = true)&#xd;
						#end&#xd;
					#end&#xd;
					#if ($found == true)&#xd;
					&lt;input type="checkbox" class="course-check" name="$item" value="$item" checked="checked">&#xd;
					#else&#xd;
					&lt;input type="checkbox" class="course-check" name="$item" value="$item">&#xd;
					#end						&#xd;
					&lt;label for="$item" class="noselect select-course truncate-name">$item&lt;/label>&#xd;
				&lt;/div>&#xd;
			#end&#xd;
			&lt;/div>&#xd;
		&lt;/div>&#xd;
	&lt;/div>&#xd;
	&lt;div class="row">&#xd;
		&lt;div class="col col-xs-12">&#xd;
			&lt;div class="buttonwrapper">&lt;input type="submit" class="button" name="submit" value="Inscriere" />&lt;/div>&#xd;
		&lt;/div>&#xd;
	&lt;/div>&#xd;
&lt;/form>&#xd;
&#xd;
&lt;script type="text/javascript">&#xd;
&#xd;
	function trimCourseNames(){&#xd;
		for (let label of document.getElementsByClassName('truncate-name')){&#xd;
			let content = label.getAttribute('title');&#xd;
			let len = label.parentNode.offsetWidth/10;&#xd;
			if(content.length>len)&#xd;
				content = content.substring(0,len)+'...';&#xd;
			label.innerHTML=content;&#xd;
		}&#xd;
	}&#xd;
&#xd;
	function showHideCourses(){&#xd;
		document.getElementById('courses-panel').classList.toggle('visible');&#xd;
		document.getElementById('courses-trigger').classList.toggle('triggered');&#xd;
	}&#xd;
&#xd;
	function updateSelectedCourses(){&#xd;
		let counter = 0;&#xd;
		for(let course of document.getElementsByClassName('course-check')){&#xd;
			if (course.getAttribute('checked'))&#xd;
				counter++;&#xd;
		}&#xd;
		return counter;&#xd;
	}&#xd;
&#xd;
	function updateSelectedCoursesOutput(selectedCourses){&#xd;
		let output = document.getElementById('courses-status');&#xd;
		output.innerHTML = '('+selectedCourses+'/$maxCourses)';&#xd;
		if(selectedCourses!==$maxCourses)&#xd;
			output.classList.add('errors');&#xd;
		else&#xd;
			output.classList.remove('errors');&#xd;
	}&#xd;
	updateSelectedCoursesOutput(updateSelectedCourses())&#xd;
	let coursesPanel = document.getElementById('courses-panel');&#xd;
	for (let label of document.getElementsByClassName('truncate-name')){&#xd;
		let content = label.innerHTML;&#xd;
		label.setAttribute('title', content);&#xd;
		label.addEventListener('click', function(){&#xd;
			let selectedCourses = updateSelectedCourses();&#xd;
			this.classList.toggle('selected');&#xd;
			let checkBox = this.previousElementSibling;&#xd;
			if(checkBox.getAttribute('checked')){&#xd;
				checkBox.removeAttribute('checked');&#xd;
				selectedCourses-=1;&#xd;
			}else{&#xd;
				if(selectedCourses&lt;$maxCourses){&#xd;
					checkBox.setAttribute('checked', 'checked');&#xd;
					selectedCourses+=1;&#xd;
				}&#xd;
			}&#xd;
			updateSelectedCoursesOutput(selectedCourses);&#xd;
		});&#xd;
	}&#xd;
	trimCourseNames();&#xd;
	window.addEventListener('resize', trimCourseNames);&#xd;
&#xd;
	for(let trigger of document.getElementsByClassName('triggers-panel')){&#xd;
		trigger.addEventListener('click', function(){&#xd;
			showHideCourses();&#xd;
		});&#xd;
	}&#xd;
&#xd;
&lt;/script>&#xd;
{{/html}}&#xd;
&#xd;
{{/velocity}}&#xd;
&#xd;
&#xd;
 &#xd;
</content>
</xwikidoc>